# 專案架構總覽 - 技術棧選型和整體設計

## 🎯 多重專案核心目標

### 1. Veeva OpenData 模擬系統
建立一個展示SQL能力和資料品質管理的系統，重點在於：
- **複雜SQL查詢能力** (60%權重)
- **資料品質驗證邏輯**
- **跨系統資料整合**
- **增量更新處理**
- **商業規則實作**

### 2. Serena AI代理系統集成
- **38個專業AI代理**支持全開發週期
- **Claude Code Templates**提供項目模板
- **多語言LSP支持**統一開發體驗
- **實時監控和分析**系統

### 3. COVID-19研究數據處理
- **8大類別研究表格**結構化處理
- **多格式支持** (CSV, XLSX, DOCX, PDF)
- **科學問題映射**和風險因素分析

## 📊 整合技術棧選型

### 核心AI代理技術
- **Serena Framework**: Python-based AI agent system
- **Claude Code Integration**: CLI tools + 38 specialized agents
- **LSP Support**: 15+ programming languages
- **MCP Protocol**: Model Context Protocol for agent communication

### 數據處理技術
- **資料庫**: SQLite (開發環境) / PostgreSQL (生產環境)
- **SQL引擎**: 原生SQL + SQLAlchemy (ORM層)
- **程式語言**: Python 3.11 (協調層)
- **資料驗證**: Great Expectations + 自定義SQL規則
- **增量處理**: CDC (Change Data Capture) 設計模式
- **排程系統**: Apache Airflow (或簡化版 schedule library)

### 資料層架構

```
┌─────────────────────────────────────────┐
│         資料來源層 (Source Layer)        │
├─────────────────────────────────────────┤
│ • CORD-19 Dataset (模擬醫療人員資料)     │
│ • 分割為多個來源模擬不同供應商           │
│ • 故意製造資料不一致性                   │
└─────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────┐
│        暫存層 (Staging Layer)            │
├─────────────────────────────────────────┤
│ • Raw Tables: source1_authors,           │
│   source2_authors, source3_institutions  │
│ • Change Tracking Tables                 │
│ • Audit Log Tables                       │
└─────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────┐
│      整合層 (Integration Layer)          │
├─────────────────────────────────────────┤
│ • Matching & Deduplication Logic         │
│ • Reconciliation Rules                   │
│ • Conflict Resolution                    │
└─────────────────────────────────────────┘
                    ▼
┌─────────────────────────────────────────┐
│        核心層 (Core Layer)               │
├─────────────────────────────────────────┤
│ • Golden Records Tables                  │
│ • Master Data: dim_authors,              │
│   dim_institutions, fact_publications    │
│ • Data Quality Metrics                   │
└─────────────────────────────────────────┘
```

## 🗄️ 資料模型設計

### 主要實體關係

```sql
-- 核心維度表：作者資料
CREATE TABLE dim_authors (
    author_id VARCHAR(50) PRIMARY KEY,
    author_name VARCHAR(200) NOT NULL,
    normalized_name VARCHAR(200),
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    middle_initial VARCHAR(10),
    email VARCHAR(100),
    orcid VARCHAR(20),
    license_number VARCHAR(50),
    specialization VARCHAR(100),
    last_updated TIMESTAMP,
    source_system VARCHAR(50),
    is_golden_record BOOLEAN,
    confidence_score DECIMAL(3,2)
);

-- 核心維度表：機構資料
CREATE TABLE dim_institutions (
    institution_id VARCHAR(50) PRIMARY KEY,
    institution_name VARCHAR(300),
    normalized_name VARCHAR(300),
    institution_type VARCHAR(50),
    country VARCHAR(100),
    state_province VARCHAR(100),
    city VARCHAR(100),
    postal_code VARCHAR(20),
    address_line1 VARCHAR(200),
    address_line2 VARCHAR(200),
    phone VARCHAR(50),
    website VARCHAR(200),
    validation_status VARCHAR(20),
    last_verified DATE
);

-- 事實表：發表記錄
CREATE TABLE fact_publications (
    publication_id VARCHAR(50) PRIMARY KEY,
    author_id VARCHAR(50),
    institution_id VARCHAR(50),
    publication_date DATE,
    journal_name VARCHAR(200),
    publication_type VARCHAR(50),
    citation_count INTEGER,
    doi VARCHAR(100),
    pmid VARCHAR(50),
    is_primary_author BOOLEAN,
    FOREIGN KEY (author_id) REFERENCES dim_authors(author_id),
    FOREIGN KEY (institution_id) REFERENCES dim_institutions(institution_id)
);

-- 關聯表：作者-機構關係
CREATE TABLE author_institution_affiliation (
    affiliation_id SERIAL PRIMARY KEY,
    author_id VARCHAR(50),
    institution_id VARCHAR(50),
    start_date DATE,
    end_date DATE,
    position_title VARCHAR(100),
    is_primary BOOLEAN,
    department VARCHAR(100),
    FOREIGN KEY (author_id) REFERENCES dim_authors(author_id),
    FOREIGN KEY (institution_id) REFERENCES dim_institutions(institution_id)
);
```

## 🔍 資料品質框架

### 驗證層級架構

1. **Schema驗證**
   - 資料型別檢查
   - 必填欄位驗證
   - 格式規則（email、phone、postal code）
   - 長度限制檢查

2. **參照完整性**
   - Foreign key完整性
   - 孤立記錄偵測
   - 循環參照檢查
   - 階層關係驗證

3. **商業規則驗證**
   - 一個醫生不能同時隸屬超過5個機構
   - 發表數量異常檢測（每月>50篇）
   - 執照號碼有效性驗證
   - 地址完整性檢查

4. **統計異常偵測**
   - 離群值分析
   - 趨勢異常識別
   - 分布偏差檢測
   - 時間序列異常

5. **跨源一致性**
   - 名稱標準化對比
   - 重複記錄識別
   - 衝突資料標記
   - 可信度評分

### 品質指標 (KPIs)

```sql
-- 資料品質評分表
CREATE TABLE data_quality_metrics (
    metric_id SERIAL PRIMARY KEY,
    metric_date DATE,
    table_name VARCHAR(50),
    completeness_score DECIMAL(5,2),
    consistency_score DECIMAL(5,2),
    accuracy_score DECIMAL(5,2),
    timeliness_score DECIMAL(5,2),
    uniqueness_score DECIMAL(5,2),
    overall_score DECIMAL(5,2),
    total_records INTEGER,
    invalid_records INTEGER,
    duplicate_records INTEGER
);
```

## 🔄 增量更新架構

### CDC實作策略

```sql
-- 變更追蹤表
CREATE TABLE change_log (
    log_id SERIAL PRIMARY KEY,
    table_name VARCHAR(50),
    record_id VARCHAR(50),
    operation VARCHAR(10), -- INSERT/UPDATE/DELETE
    changed_columns JSONB,
    old_values JSONB,
    new_values JSONB,
    change_timestamp TIMESTAMP,
    source_system VARCHAR(50),
    batch_id VARCHAR(50),
    processed_flag BOOLEAN DEFAULT FALSE,
    processed_timestamp TIMESTAMP
);

-- 批次處理控制表
CREATE TABLE batch_control (
    batch_id VARCHAR(50) PRIMARY KEY,
    batch_date DATE,
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    status VARCHAR(20),
    records_processed INTEGER,
    records_inserted INTEGER,
    records_updated INTEGER,
    records_deleted INTEGER,
    error_count INTEGER,
    error_details JSONB
);
```

### 處理流程
1. **擷取變更** - 識別新增/修改/刪除的記錄
2. **驗證變更** - 套用資料品質規則
3. **套用商業規則** - 執行領域特定邏輯
4. **衝突解決** - 處理多源資料衝突
5. **更新Golden Records** - 維護單一真實來源
6. **記錄審計軌跡** - 完整的變更歷史

## ⚡ 效能優化策略

### 索引設計
```sql
-- 主要索引
CREATE INDEX idx_author_name ON dim_authors(normalized_name);
CREATE INDEX idx_author_email ON dim_authors(email);
CREATE INDEX idx_institution_location ON dim_institutions(country, state_province, city);
CREATE INDEX idx_publication_date ON fact_publications(publication_date);
CREATE INDEX idx_affiliation_active ON author_institution_affiliation(author_id, institution_id) 
    WHERE end_date IS NULL;

-- 複合索引（常用查詢組合）
CREATE INDEX idx_author_institution ON fact_publications(author_id, institution_id);
CREATE INDEX idx_change_log_lookup ON change_log(table_name, record_id, change_timestamp);
```

### 查詢優化技巧
- 使用CTEs (Common Table Expressions)取代巢狀子查詢
- 適當的JOIN順序和JOIN類型選擇
- 分區表設計（按月份分區）
- Materialized Views建立（常用聚合查詢）
- Query Plan分析和調優

## 🔐 安全性考量

### 資料保護措施
- PII資料遮罩和加密
- 角色基礎存取控制 (RBAC)
- 審計日誌完整性保護
- 定期備份與災難復原計畫
- 資料保留政策實施

## 📁 專案目錄結構

```
veeva-data-quality-system/
├── sql/
│   ├── 01_schema/           # 資料庫schema定義
│   ├── 02_validation/        # 驗證查詢SQL
│   ├── 03_reconciliation/    # 資料整合SQL
│   ├── 04_incremental/       # 增量更新SQL
│   ├── 05_business_rules/    # 商業規則SQL
│   └── 06_reporting/         # 報表查詢SQL
├── python/
│   ├── pipeline/             # ETL pipeline程式碼
│   ├── validation/           # 驗證邏輯
│   ├── utils/                # 工具函數
│   └── config/               # 設定檔
├── tests/
│   ├── unit/                 # 單元測試
│   ├── integration/          # 整合測試
│   └── performance/          # 效能測試
├── docs/
│   ├── architecture.md       # 架構文檔
│   ├── data_dictionary.md    # 資料字典
│   └── user_guide.md         # 使用指南
└── reports/
    ├── quality_metrics/      # 品質報表
    └── reconciliation/       # 整合報表
```

## 🤖 AI代理集成架構

### Contains Studio代理生態 (38個專業代理)
```
agents/
├── engineering/ (7個)
│   ├── rapid-prototyper.md     # 快速原型開發
│   ├── ai-engineer.md          # AI/ML功能集成
│   ├── backend-architect.md    # 可擴展API設計
│   ├── frontend-developer.md   # 高性能UI開發
│   ├── mobile-app-builder.md   # 原生移動應用
│   ├── devops-automator.md     # 持續部署
│   └── test-writer-fixer.md    # 測試編寫和修復
├── design/ (5個)
│   ├── ui-designer.md          # 界面設計
│   ├── brand-guardian.md       # 品牌一致性
│   ├── ux-researcher.md        # 用戶體驗研究
│   ├── visual-storyteller.md   # 視覺敘事
│   └── whimsy-injector.md      # 用戶體驗驚喜
├── marketing/ (7個)
│   ├── tiktok-strategist.md    # TikTok營銷策略
│   ├── growth-hacker.md        # 增長黑客
│   ├── content-creator.md      # 內容創建
│   ├── app-store-optimizer.md  # 應用商店優化
│   ├── instagram-curator.md    # Instagram策劃
│   ├── reddit-community-builder.md # Reddit社區
│   └── twitter-engager.md      # Twitter互動
├── product/ (3個)
│   ├── trend-researcher.md     # 趨勢研究
│   ├── feedback-synthesizer.md # 反饋綜合
│   └── sprint-prioritizer.md   # 衝刺優先級
├── project-management/ (3個)
│   ├── experiment-tracker.md   # 實驗跟踪
│   ├── project-shipper.md      # 項目交付
│   └── studio-producer.md      # 工作室製作
├── studio-operations/ (5個)
│   ├── analytics-reporter.md   # 分析報告
│   ├── finance-tracker.md      # 財務跟踪
│   ├── infrastructure-maintainer.md # 基礎設施維護
│   ├── legal-compliance-checker.md # 法律合規
│   └── support-responder.md    # 支持響應
├── testing/ (5個)
│   ├── performance-benchmarker.md # 性能基準測試
│   ├── api-tester.md           # API測試
│   ├── test-results-analyzer.md # 測試結果分析
│   ├── tool-evaluator.md       # 工具評估
│   └── workflow-optimizer.md   # 工作流優化
└── bonus/ (2個)
    ├── studio-coach.md         # 工作室教練
    └── joker.md                # 幽默注入
```

### Claude Code Templates集成
- **CLI工具**: `npx claude-code-templates@latest`
- **功能模塊**:
  - 項目設置和配置
  - 實時分析儀表板
  - 健康檢查系統
  - 組件安裝管理
  - 工作流自動化

### 多語言LSP支持 (15+語言)
```
solidlsp/language_servers/
├── python (pyright, jedi)
├── typescript/javascript (ts-server)
├── rust (rust-analyzer)
├── go (gopls)
├── java (eclipse-jdtls)
├── csharp (omnisharp)
├── php (intelephense)
├── ruby (solargraph)
├── bash (bash-language-server)
├── clojure (clojure-lsp)
├── dart (dart-server)
├── elixir (elixir-ls)
├── kotlin (kotlin-language-server)
├── terraform (terraform-ls)
└── vts (vetur/volar)
```

## 🚀 整合實作優先順序

### Phase 1: AI代理基礎設施 (Day 1)
- ✅ 安裝Contains Studio代理集合
- ✅ 配置Claude Code Templates CLI
- ✅ 設置Serena記憶系統
- ✅ 建立AI代理協作框架

### Phase 2: 數據處理基礎 (Day 2)
- 建立資料庫schema (rapid-prototyper + backend-architect)
- 匯入CORD-19樣本資料 (ai-engineer支持)
- 建立基本索引和約束 (performance-benchmarker驗證)

### Phase 3: 智能資料品質 (Day 3)
- 實作20個驗證查詢 (backend-architect + ai-engineer)
- 建立AI增強品質評分系統 (analytics-reporter)
- 產生第一份智能品質報告 (visual-storyteller)

### Phase 4: AI輔助資料整合 (Day 4)
- 實作智能matching邏輯 (ai-engineer)
- AI驅動reconciliation規則 (trend-researcher分析)
- 智能處理資料衝突 (feedback-synthesizer)

### Phase 5: 自動化增量處理 (Day 5)
- 實作CDC機制 (devops-automator)
- 建立自動化批次處理 (workflow-optimizer)
- AI監控效能和擴展性 (infrastructure-maintainer)

### Phase 6: 商業智能和交付 (Day 6)
- AI增強商業規則 (sprint-prioritizer決策)
- 智能違規處理流程 (legal-compliance-checker)
- 全面項目交付 (project-shipper統籌)

## 📈 AI代理協作優勢

### 1. 自動化工作流
- **studio-coach**: 協調多代理任務
- **experiment-tracker**: 自動跟踪開發實驗
- **workflow-optimizer**: 持續優化開發流程

### 2. 質量保證
- **test-writer-fixer**: 自動生成和修復測試
- **performance-benchmarker**: 持續性能監控
- **tool-evaluator**: 評估和推薦最佳工具

### 3. 智能決策支持
- **trend-researcher**: 識別技術和市場趨勢
- **analytics-reporter**: 數據驅動決策支持
- **feedback-synthesizer**: 用戶反饋智能分析

## 🔄 記憶系統更新狀態
- **最後更新**: 2025-08-07
- **版本**: v2.0.0 (AI代理增強版)
- **狀態**: 完整AI代理生態系統就緒，支持智能化開發全流程